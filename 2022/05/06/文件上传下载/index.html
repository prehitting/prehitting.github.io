<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="文件上传下载功能, 孤注一掷"><meta name="description" content="欢迎来到鸣崽的空间，这里不仅有学习，还有生活"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>文件上传下载功能 | 不利索の鸣</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 6.2.0"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">不利索の鸣</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">不利索の鸣</div><div class="logo-desc">欢迎来到鸣崽的空间，这里不仅有学习，还有生活</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/prehitting" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/prehitting" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/5.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">文件上传下载功能</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/SpringBoot/"><span class="chip bg-color">SpringBoot</span> </a><a href="/tags/SpringMVC/"><span class="chip bg-color">SpringMVC</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SpringMVC/" class="post-category">SpringMVC</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2022-05-06</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2022-06-18</div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="基于springmvc的文件上传"><a class="markdownIt-Anchor" href="#基于springmvc的文件上传">#</a> 基于 SpringMVC 的文件上传</h2><h3 id="1-multipartfile接口"><a class="markdownIt-Anchor" href="#1-multipartfile接口">#</a> 1 MultipartFile 接口</h3><p>MultipartFile 接口常用的的 API 见下表：</p><table><thead><tr><th style="text-align:left">方法</th><th>功能描述</th></tr></thead><tbody><tr><td style="text-align:left">String getOriginalFilename()</td><td>获取上传文件的原始文件名，即该文件在客户端中的文件名</td></tr><tr><td style="text-align:left">boolean isEmpty()</td><td>判断上传的文件是否为空，当没有选择文件就直接上传，或者选中的文件是 0 字节的空文件时，返回 true，否则返回 false</td></tr><tr><td style="text-align:left">long getSize()</td><td>获取上传的文件大小，以字节为单位</td></tr><tr><td style="text-align:left">String getContentType()</td><td>根据所上传的文件的扩展名决定该文件的 MIME 类型，例如上传.jpg 格式的图片，将返回 image/jpeg</td></tr><tr><td style="text-align:left">InputStream getInputStream()</td><td>获取上传文件的输入字节流，通常用于自定义读取所上传的文件的过程，该方法与 transferTo () 方法不可以同时使用</td></tr><tr><td style="text-align:left">void transferTo(File dest)</td><td>保存上传的文件，该方法与 getInputStream () 方法不可以同时使用</td></tr></tbody></table><h3 id="2-multipartresolver接口"><a class="markdownIt-Anchor" href="#2-multipartresolver接口">#</a> 2 MultipartResolver 接口</h3><p>1.MultipartResolver 可以将上传过程中产生的数据封装为 MultipartFile 类型的对象中。</p><p>2. 在配置 MultipartResovler 时，可以为其中的几个属性注入值：</p><ul><li>maxUploadSize：上传文件的最大大小，假设设置值为 10M，一次性上传 5 个文件，则 5 个文件的大小总和不允许超过 10M。</li><li>maxUploadSizePerFile：每个上传文件的最大大小，假设设置值为 10M，一次性上传 5 个文件，则每个文件的大小都不可以超过 10M，但是 5 个文件的大小总和可以接近 50M。</li><li>defaultEncoding：默认编码。</li></ul><h3 id="3-基于springmvc的文件上传案例"><a class="markdownIt-Anchor" href="#3-基于springmvc的文件上传案例">#</a> 3 基于 SpringMVC 的文件上传案例</h3><h4 id="31-创建项目"><a class="markdownIt-Anchor" href="#31-创建项目">#</a> 3.1 创建项目</h4><p>1. 创建 Java Enterprise 项目，设置 Name 为 springmvc-upload，<a target="_blank" rel="noopener" href="http://xn--Groupcom-1g0m.cy">Group 为 com.cy</a>，Artifact 为 controller 的 Java 企业级项目。</p><p>2. 将项目 com.cy.controller 包下自动生成的 HelloServlet 类删除，并删除 webapp 下自动生成的 index.jsp 文件。</p><p>3. 添加文件上传 jar 包依赖（关于文件上传需要添加 spring-webmvc 和 commons-fileupload 依赖）。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 文件上传 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4. 在 src\main\resources 文件夹下创建 spring 配置文件，并将文件命名为 spring-upload.xml。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/context/spring-context-4.3.xsd&quot;</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="32-前端页面设计"><a class="markdownIt-Anchor" href="#32-前端页面设计">#</a> 3.2 前端页面设计</h4><p>在 webapp 目录下创建 upload.html 页面，并在页面中添加如下代码。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- enctype属性：规定表单中数据在提交给服务器之前如何进行编码。默认表单数据的编码是&quot;application/x-www-form-urlencoded&quot;。</span></span><br><span class="line"><span class="comment">         application/x-www-form-urlencoded：提交前表单中所有数据都会进行编码；编码的规则是：空格转换为&quot;+&quot;加号，特殊符号转换为ASCII HEX值</span></span><br><span class="line"><span class="comment">         text/plain：提交前表单中数据空格转换为&quot;+&quot;加号，但不对特殊字符进行编码。</span></span><br><span class="line"><span class="comment">         multipart/form-data：提交前表单中不对字符进行编码；在使用包含文件上传控件的表单中，必须使用该值</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.do&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>文件名(N)：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;上传&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意</strong>：form 表单的请求方式必须设置为 POST，并配置属性 enctype=“multipart/form-data”，文件上传 input 控件的 name 属性值需设置为 file 值。</p></blockquote><h4 id="33-后台功能实现"><a class="markdownIt-Anchor" href="#33-后台功能实现">#</a> 3.3 后台功能实现</h4><p>1. 在 web.xml 文件中配置前端控制器和过滤器，并指定 DispatcherServlet 加载的配置文件 springmvc-upload.xml 的位置。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc-upload.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2. 创建 com.cy.controller.UploadController 控制器类，在类的声明之前添加 @Controller 注解，并在控制器中添加处理请求的 upload () 方法，为此方法添加类型为 MultipartFile 接口的参数，并为该参数添加 @RequestParam 注解，表示客户端上传的文件。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @RequestMapping(&quot;upload.do&quot;)</span></span><br><span class="line"><span class="comment">    @ResponseBody</span></span><br><span class="line"><span class="comment">    public String upload(@RequestParam(&quot;file&quot;) MultipartFile file) &#123;</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;UploadController.upload()...&quot;);</span></span><br><span class="line"><span class="comment">        File dest = new File(&quot;D:/1.png&quot;);</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            // 调用MultipartFile参数对象的transferTo()方法即可保存上传的文件</span></span><br><span class="line"><span class="comment">            file.transferTo(dest);</span></span><br><span class="line"><span class="comment">        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return &quot;OK&quot;;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;upload.do&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(HttpServletRequest request, <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 获取上传文件的原始文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="comment">// 获取上下文的绝对路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span> request.getServletContext().getRealPath(<span class="string">&quot;upload&quot;</span>);</span><br><span class="line">        System.out.println(realPath);</span><br><span class="line">        <span class="comment">// 创建File文件对象</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(realPath);</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 自定义上传文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 获取上传文件扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">beginIndex</span> <span class="operator">=</span> originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (beginIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            suffix = originalFilename.substring(beginIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullFilename</span> <span class="operator">=</span> fileName + suffix;</span><br><span class="line">        <span class="comment">// 调用MultipartFile参数对象的transferTo()方法即可保存上传的文件</span></span><br><span class="line">        file.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(dir, fullFilename));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3. 在 springmvc-upload.xml 配置文件中添加组件扫描和 CommonsMultipartResolver 类的 bean 标签配置。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 组件扫描 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.cy&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- CommonsMultipartResolver --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;multipartResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意</strong>：CommonsMultipartResolver 类在配置时，id 值必须设置成 multipartResolver。</p></blockquote><p>4. 启动项目，访问 http://localhost:8080/springmvc_upload_war_exploded/upload.html 网址测试文件提交。</p><h2 id="上传头像"><a class="markdownIt-Anchor" href="#上传头像">#</a> 上传头像</h2><h3 id="1-用户-上传头像-持久层"><a class="markdownIt-Anchor" href="#1-用户-上传头像-持久层">#</a> 1 用户 - 上传头像 - 持久层</h3><h4 id="11-规划需要执行的sql语句"><a class="markdownIt-Anchor" href="#11-规划需要执行的sql语句">#</a> 1.1 规划需要执行的 SQL 语句</h4><p>上传文件的操作其实是：先将用户上传的文件保存到服务器端的某个位置，然后将保存文件的路径记录在数据库中。当后续需要使用该文件时，从数据库中读出文件的路径，即可实现在线访问该文件。</p><p>在持久层处理数据库中的数据时，只需要关心如何记录头像文件的路径，并不需要考虑上传时保存文件的过程。所以，需要执行的 SQL 语句大致是：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update t_user set avatar=?, modified_user=?, modified_time=? where uid=?</span><br></pre></td></tr></table></figure><h4 id="12-接口与抽象方法"><a class="markdownIt-Anchor" href="#12-接口与抽象方法">#</a> 1.2 接口与抽象方法</h4><p>在 UserMapper 接口中添加 updateAvatarByUid () 抽象方法。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据uid更新用户的头像</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uid 用户的id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> avatar 新头像的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> modifiedUser 修改执行人</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> modifiedTime 修改时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 受影响的行数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Integer <span class="title function_">updateAvatarByUid</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="meta">@Param(&quot;uid&quot;)</span> Integer uid,</span></span><br><span class="line"><span class="params">		<span class="meta">@Param(&quot;avatar&quot;)</span> String avatar,</span></span><br><span class="line"><span class="params">		<span class="meta">@Param(&quot;modifiedUser&quot;)</span> String modifiedUser,</span></span><br><span class="line"><span class="params">		<span class="meta">@Param(&quot;modifiedTime&quot;)</span> Date modifiedTime)</span>;</span><br></pre></td></tr></table></figure><h4 id="13-配置sql映射"><a class="markdownIt-Anchor" href="#13-配置sql映射">#</a> 1.3 配置 SQL 映射</h4><p>1. 在 UserMapper.xml 中配置 updateAvatarByUid () 抽象方法的映射。</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 根据uid更新用户的头像</span></span><br><span class="line"><span class="comment">	 Integer updateAvatarByUid(</span></span><br><span class="line"><span class="comment">		@Param(&quot;uid&quot;) Integer uid,</span></span><br><span class="line"><span class="comment">		@Param(&quot;avatar&quot;) String avatar,</span></span><br><span class="line"><span class="comment">		@Param(&quot;modifiedUser&quot;) String modifiedUser,</span></span><br><span class="line"><span class="comment">		@Param(&quot;modifiedTime&quot;) Date modifiedTime) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateAvatarByUid&quot;</span>&gt;</span></span><br><span class="line">	UPDATE</span><br><span class="line">		t_user</span><br><span class="line">	SET</span><br><span class="line">		avatar = #&#123;avatar&#125;,</span><br><span class="line">		modified_user = #&#123;modifiedUser&#125;,</span><br><span class="line">		modified_time = #&#123;modifiedTime&#125;</span><br><span class="line">	WHERE</span><br><span class="line">		uid = #&#123;uid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2. 在 UserMapperTests 中编写并执行单元测试。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateAvatarByUid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">uid</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">avatar</span> <span class="operator">=</span> <span class="string">&quot;/upload/avatar.png&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">modifiedUser</span> <span class="operator">=</span> <span class="string">&quot;超级管理员&quot;</span>;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">modifiedTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">rows</span> <span class="operator">=</span> userMapper.updateAvatarByUid(uid, avatar, modifiedUser, modifiedTime);</span><br><span class="line">    System.out.println(<span class="string">&quot;rows=&quot;</span> + rows);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-用户-上传头像-业务层"><a class="markdownIt-Anchor" href="#2-用户-上传头像-业务层">#</a> 2 用户 - 上传头像 - 业务层</h3><h4 id="21-规划异常"><a class="markdownIt-Anchor" href="#21-规划异常">#</a> 2.1 规划异常</h4><p>在修改头像值前先检查用户数据状态，可能抛 UserNotFoundException 异常；由于最终执行的是修改操作还可能抛 UpdateException 异常。</p><h4 id="22-接口与抽象方法"><a class="markdownIt-Anchor" href="#22-接口与抽象方法">#</a> 2.2 接口与抽象方法</h4><p>在 IUserService 中添加 changeAvatar (Integer uid, String username, String avatar) 抽象方法。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改用户头像</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uid 当前登录的用户的id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username 当前登录的用户名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> avatar 用户的新头像的路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">changeAvatar</span><span class="params">(Integer uid, String username, String avatar)</span>;</span><br></pre></td></tr></table></figure><h4 id="23-实现抽象方法"><a class="markdownIt-Anchor" href="#23-实现抽象方法">#</a> 2.3 实现抽象方法</h4><p>1. 在 UserServiceImpl 类中实现 changeAvatar (Integer uid, String username, String avatar) 方法。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeAvatar</span><span class="params">(Integer uid, String username, String avatar)</span> &#123;</span><br><span class="line">    <span class="comment">// 调用userMapper的findByUid()方法，根据参数uid查询用户数据</span></span><br><span class="line">    <span class="comment">// 检查查询结果是否为null</span></span><br><span class="line">    <span class="comment">// 是：抛出UserNotFoundException</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查查询结果中的isDelete是否为1</span></span><br><span class="line">    <span class="comment">// 是：抛出UserNotFoundException</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建当前时间对象</span></span><br><span class="line">    <span class="comment">// 调用userMapper的updateAvatarByUid()方法执行更新，并获取返回值</span></span><br><span class="line">    <span class="comment">// 判断以上返回的受影响行数是否不为1</span></span><br><span class="line">    <span class="comment">// 是：抛了UpdateException</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.changeAvatar (Integer uid, String username, String avatar) 方法中代码的具体实现为。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeAvatar</span><span class="params">(Integer uid, String username, String avatar)</span> &#123;</span><br><span class="line">	<span class="comment">// 调用userMapper的findByUid()方法，根据参数uid查询用户数据</span></span><br><span class="line">	<span class="type">User</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.findByUid(uid);</span><br><span class="line">	<span class="comment">// 检查查询结果是否为null</span></span><br><span class="line">	<span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// 是：抛出UserNotFoundException</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserNotFoundException</span>(<span class="string">&quot;用户数据不存在&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 检查查询结果中的isDelete是否为1</span></span><br><span class="line">	<span class="keyword">if</span> (result.getIsDelete().equals(<span class="number">1</span>)) &#123;</span><br><span class="line">		<span class="comment">// 是：抛出UserNotFoundException</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserNotFoundException</span>(<span class="string">&quot;用户数据不存在&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建当前时间对象</span></span><br><span class="line">	<span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">	<span class="comment">// 调用userMapper的updateAvatarByUid()方法执行更新，并获取返回值</span></span><br><span class="line">	<span class="type">Integer</span> <span class="variable">rows</span> <span class="operator">=</span> userMapper.updateAvatarByUid(uid, avatar, username, now);</span><br><span class="line">	<span class="comment">// 判断以上返回的受影响行数是否不为1</span></span><br><span class="line">	<span class="keyword">if</span> (rows != <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">// 是：抛出UpdateException</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UpdateException</span>(<span class="string">&quot;更新用户数据时出现未知错误，请联系系统管理员&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3. 在 UserServiceTests 类中进行单元测试。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeAvatar</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">uid</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;头像管理员&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">avatar</span> <span class="operator">=</span> <span class="string">&quot;/upload/avatar.png&quot;</span>;</span><br><span class="line">        userService.changeAvatar(uid, username, avatar);</span><br><span class="line">        System.out.println(<span class="string">&quot;OK.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        System.out.println(e.getClass().getSimpleName());</span><br><span class="line">        System.out.println(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-用户-上传头像-控制器"><a class="markdownIt-Anchor" href="#3-用户-上传头像-控制器">#</a> 3 用户 - 上传头像 - 控制器</h3><h4 id="31-处理异常"><a class="markdownIt-Anchor" href="#31-处理异常">#</a> 3.1 处理异常</h4><p>1. 在处理上传文件的过程中，用户可能会选择错误的文件上传，此时就应该抛出对应的异常并进行处理。所以需要创建文件上传相关异常的基类，即在 com.cy.store.controller.ex 包下创建 FileUploadException 类，并继承自 RuntimeException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 文件上传相关异常的基类 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileUploadException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileUploadException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileUploadException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileUploadException</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">FileUploadException</span><span class="params">(String message, Throwable cause, <span class="type">boolean</span> enableSuppression, <span class="type">boolean</span> writableStackTrace)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2. 在处理上传的文件过程中，经分析可能会产生以下异常。这些异常类都需要继承自 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 上传的文件为空</span></span><br><span class="line">cn.tedu.store.controller.ex.FileEmptyException</span><br><span class="line"><span class="comment">// 上传的文件大小超出了限制值</span></span><br><span class="line">cn.tedu.store.controller.ex.FileSizeException</span><br><span class="line"><span class="comment">// 上传的文件类型超出了限制</span></span><br><span class="line">cn.tedu.store.controller.ex.FileTypeException</span><br><span class="line"><span class="comment">// 上传的文件状态异常</span></span><br><span class="line">cn.tedu.store.controller.ex.FileStateException</span><br><span class="line"><span class="comment">// 上传文件时读写异常</span></span><br><span class="line">cn.tedu.store.controller.ex.FileUploadIOException</span><br></pre></td></tr></table></figure><p>3. 创建 FileEmptyException 异常类，并继承 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 上传的文件为空的异常，例如没有选择上传的文件就提交了表单，或选择的文件是0字节的空文件 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileEmptyException</span> <span class="keyword">extends</span> <span class="title class_">FileUploadException</span> &#123;</span><br><span class="line">    <span class="comment">// Override Methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4. 创建 FileSizeException 异常类，并继承 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 上传的文件的大小超出了限制值 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSizeException</span> <span class="keyword">extends</span> <span class="title class_">FileUploadException</span> &#123;</span><br><span class="line">    <span class="comment">// Override Methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5. 创建 FileTypeException 异常类，并继承 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 上传的文件类型超出了限制 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileTypeException</span> <span class="keyword">extends</span> <span class="title class_">FileUploadException</span> &#123;</span><br><span class="line">    <span class="comment">// Override Methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>6. 创建 FileStateException 异常类，并继承 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 上传的文件状态异常 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStateException</span> <span class="keyword">extends</span> <span class="title class_">FileUploadException</span> &#123;</span><br><span class="line">    <span class="comment">// Override Methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>7. 创建 FileUploadIOException 异常类，并继承 FileUploadException 类。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store.service.ex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 上传文件时读写异常 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadIOException</span> <span class="keyword">extends</span> <span class="title class_">FileUploadException</span> &#123;</span><br><span class="line">    <span class="comment">// Override Methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>8. 然后在 BaseController 的 handleException () 的 @ExceptionHandler 注解中添加 FileUploadException.class 异常的处理；最后在方法中处理这些异常。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(&#123;ServiceException.class, FileUploadException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> JsonResult&lt;Void&gt; <span class="title function_">handleException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">	JsonResult&lt;Void&gt; result = <span class="keyword">new</span> <span class="title class_">JsonResult</span>&lt;Void&gt;(e);</span><br><span class="line">	<span class="keyword">if</span> (e <span class="keyword">instanceof</span> UsernameDuplicateException) &#123;</span><br><span class="line">		result.setState(<span class="number">4000</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> UserNotFoundException) &#123;</span><br><span class="line">		result.setState(<span class="number">4001</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> PasswordNotMatchException) &#123;</span><br><span class="line">		result.setState(<span class="number">4002</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InsertException) &#123;</span><br><span class="line">		result.setState(<span class="number">5000</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> UpdateException) &#123;</span><br><span class="line">		result.setState(<span class="number">5001</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FileEmptyException) &#123;</span><br><span class="line">		result.setState(<span class="number">6000</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FileSizeException) &#123;</span><br><span class="line">		result.setState(<span class="number">6001</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FileTypeException) &#123;</span><br><span class="line">		result.setState(<span class="number">6002</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FileStateException) &#123;</span><br><span class="line">		result.setState(<span class="number">6003</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FileUploadIOException) &#123;</span><br><span class="line">		result.setState(<span class="number">6004</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="32-设计请求"><a class="markdownIt-Anchor" href="#32-设计请求">#</a> 3.2 设计请求</h4><p>设计用户提交的请求，并设计响应的方式：</p><pre><code>请求路径：/users/change_avatar
请求参数：MultipartFile file, HttpSession session
请求类型：POST
响应结果：JsonResult&lt;String&gt;
</code></pre><h4 id="33-处理请求"><a class="markdownIt-Anchor" href="#33-处理请求">#</a> 3.3 处理请求</h4><p>1. 在 UserController 类中添加处理请求的 changeAvatar (@RequestParam (“file”) MultipartFile file, HttpSession session) 方法。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;change_avatar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> JsonResult&lt;String&gt; <span class="title function_">changeAvatar</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, HttpSession session)</span> &#123;</span><br><span class="line">	<span class="comment">// 判断上传的文件是否为空</span></span><br><span class="line">	<span class="comment">// 是：抛出异常</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 判断上传的文件大小是否超出限制值</span></span><br><span class="line">	<span class="comment">// 是：抛出异常</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 判断上传的文件类型是否超出限制</span></span><br><span class="line">	<span class="comment">// 是：抛出异常</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 获取当前项目的绝对磁盘路径</span></span><br><span class="line">	<span class="comment">// 保存头像文件的文件夹</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 保存的头像文件的文件名</span></span><br><span class="line">			</span><br><span class="line">	<span class="comment">// 创建文件对象，表示保存的头像文件</span></span><br><span class="line">	<span class="comment">// 执行保存头像文件</span></span><br><span class="line">	<span class="comment">// 如果产生异常则抛出</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 头像路径</span></span><br><span class="line">	<span class="comment">// 从Session中获取uid和username</span></span><br><span class="line">	<span class="comment">// 将头像写入到数据库中</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 返回成功和头像路径</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.changeAvatar (@RequestParam (“file”) MultipartFile file, HttpSession session) 方法中具体代码实现为。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** 头像文件大小的上限值(10MB) */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AVATAR_MAX_SIZE</span> <span class="operator">=</span> <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="comment">/** 允许上传的头像的文件类型 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; AVATAR_TYPES = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 初始化允许上传的头像的文件类型 */</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	AVATAR_TYPES.add(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">	AVATAR_TYPES.add(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">	AVATAR_TYPES.add(<span class="string">&quot;image/bmp&quot;</span>);</span><br><span class="line">	AVATAR_TYPES.add(<span class="string">&quot;image/gif&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;change_avatar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> JsonResult&lt;String&gt; <span class="title function_">changeAvatar</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, HttpSession session)</span> &#123;</span><br><span class="line">	<span class="comment">// 判断上传的文件是否为空</span></span><br><span class="line">	<span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">		<span class="comment">// 是：抛出异常</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileEmptyException</span>(<span class="string">&quot;上传的头像文件不允许为空&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 判断上传的文件大小是否超出限制值</span></span><br><span class="line">	<span class="keyword">if</span> (file.getSize() &gt; AVATAR_MAX_SIZE) &#123; <span class="comment">// getSize()：返回文件的大小，以字节为单位</span></span><br><span class="line">		<span class="comment">// 是：抛出异常</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileSizeException</span>(<span class="string">&quot;不允许上传超过&quot;</span> + (AVATAR_MAX_SIZE / <span class="number">1024</span>) + <span class="string">&quot;KB的头像文件&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 判断上传的文件类型是否超出限制</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> file.getContentType();</span><br><span class="line">	<span class="comment">// public boolean list.contains(Object o)：当前列表若包含某元素，返回结果为true；若不包含该元素，返回结果为false。</span></span><br><span class="line">	<span class="keyword">if</span> (!AVATAR_TYPES.contains(contentType)) &#123;</span><br><span class="line">		<span class="comment">// 是：抛出异常</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileTypeException</span>(<span class="string">&quot;不支持使用该类型的文件作为头像，允许的文件类型：\n&quot;</span> + AVATAR_TYPES);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 获取当前项目的绝对磁盘路径</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">parent</span> <span class="operator">=</span> session.getServletContext().getRealPath(<span class="string">&quot;upload&quot;</span>);</span><br><span class="line">	<span class="comment">// 保存头像文件的文件夹</span></span><br><span class="line">	<span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(parent);</span><br><span class="line">	<span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">		dir.mkdirs();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 保存的头像文件的文件名</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">	<span class="type">int</span> <span class="variable">beginIndex</span> <span class="operator">=</span> originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (beginIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		suffix = originalFilename.substring(beginIndex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> UUID.randomUUID().toString() + suffix;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 创建文件对象，表示保存的头像文件</span></span><br><span class="line">	<span class="type">File</span> <span class="variable">dest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir, filename);</span><br><span class="line">	<span class="comment">// 执行保存头像文件</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		file.transferTo(dest);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">		<span class="comment">// 抛出异常</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStateException</span>(<span class="string">&quot;文件状态异常，可能文件已被移动或删除&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		<span class="comment">// 抛出异常</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadIOException</span>(<span class="string">&quot;上传文件时读写错误，请稍后重尝试&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 头像路径</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">avatar</span> <span class="operator">=</span> <span class="string">&quot;/upload/&quot;</span> + filename;</span><br><span class="line">	<span class="comment">// 从Session中获取uid和username</span></span><br><span class="line">	<span class="type">Integer</span> <span class="variable">uid</span> <span class="operator">=</span> getUidFromSession(session);</span><br><span class="line">	<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> getUsernameFromSession(session);</span><br><span class="line">	<span class="comment">// 将头像写入到数据库中</span></span><br><span class="line">	userService.changeAvatar(uid, username, avatar);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 返回成功头像路径</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JsonResult</span>&lt;String&gt;(OK, avatar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-用户-上传头像-设置上传文件大小"><a class="markdownIt-Anchor" href="#4-用户-上传头像-设置上传文件大小">#</a> 4 用户 - 上传头像 - 设置上传文件大小</h3><p>1.SpringBoot 中默认 MultipartResolver 的最大文件大小值为 1M。如果上传的文件的大小超过 1M，会抛 FileSizeLimitExceededException 异常。</p><p>[外链图片转存失败，源站可能有防盗链机制，建议将图片保存下来直接上传 (img-bRrqkhoI-1650868471285)(img/2.png)]</p><p>2. 如果需要调整上传的限制值，直接在启动类中添加 getMultipartConfigElement () 方法，并且在启动类之前添加 @Configuration 注解。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.store;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.MultipartConfigFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.unit.DataSize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.unit.DataUnit;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.MultipartConfigElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.cy.store.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoreApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(StoreApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MultipartConfigElement <span class="title function_">getMultipartConfigElement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MultipartConfigFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultipartConfigFactory</span>();</span><br><span class="line">        <span class="comment">// DataSize dataSize = DataSize.ofMegabytes(10);</span></span><br><span class="line">        <span class="comment">// 设置文件最大10M，DataUnit提供5中类型B,KB,MB,GB,TB</span></span><br><span class="line">        factory.setMaxFileSize(DataSize.of(<span class="number">10</span>, DataUnit.MEGABYTES));</span><br><span class="line">        factory.setMaxRequestSize(DataSize.of(<span class="number">10</span>, DataUnit.MEGABYTES));</span><br><span class="line">        <span class="comment">// 设置总上传数据总大小10M</span></span><br><span class="line">        <span class="keyword">return</span> factory.createMultipartConfig();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3. 除了以上编写方法配置上传的上限值以外，还可以通过在 application.properties 或 application.yml 中添加配置来实现。</p><p>(1) 低版本：1.X</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.http.multipart.max-file-size</span>=<span class="string">10MB</span></span><br><span class="line"><span class="attr">spring.http.multipart.max-request-size</span>=<span class="string">10MB</span></span><br></pre></td></tr></table></figure><p>(2) 高版本：2.X</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#方式1</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.max-file-size</span>=<span class="string">10MB</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.max-request-size</span>=<span class="string">10MB</span></span><br><span class="line"><span class="comment">#方式2</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.maxFileSize</span>=<span class="string">10MB</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.maxRequestSize</span>=<span class="string">10MB</span></span><br></pre></td></tr></table></figure><h2 id="基于springbootmybatisplus"><a class="markdownIt-Anchor" href="#基于springbootmybatisplus">#</a> 基于 SpringBoot+mybatisPlus</h2><h3 id="上传"><a class="markdownIt-Anchor" href="#上传">#</a> 上传</h3><p><strong>文件上传时，对页面的 form 表单有如下要求</strong></p><ul><li><p>method = “post”----------------- 采用 post 方式提交数据</p></li><li><p>enctype = “multipart/form-data”---- 采用 multipart 格式上传文件</p></li><li><p>type = “file”--------------------- 使用 input 的 file 控件上传</p></li></ul><p>服务端要接收客户端页面上传的文件，通常使用 Apache 的两个组件：</p><ul><li>commons-fileupload</li><li>commons-io</li></ul><p>Spring 框架在 spring-web 包中对文件上传进行了封装，只需要在 Controller 方法中声明一个 MultipartFile 类型的参数即可接收上传的文件</p><h3 id="下载"><a class="markdownIt-Anchor" href="#下载">#</a> 下载</h3><p>通过浏览器进行文件下载，通常有两种形式</p><ul><li>以附件形式下载，退出保存对话框，将文件保存到指定磁盘目录</li><li>直接在浏览器中打开</li></ul><p>通过浏览器下载文件，本质是服务端将文件以流的形式写回浏览器的过程</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件上传下载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/common&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;reggie.path&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String basePath;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 文件，参数名与input组件的name属性保持一致</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        <span class="comment">//这里file为临时文件形式（拓展名.tmp）</span></span><br><span class="line">        log.info(<span class="string">&quot;文件上传:&#123;&#125;&quot;</span>,file.getOriginalFilename());</span><br><span class="line">        <span class="comment">//转存文件</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> UUID.randomUUID().toString()+suffix;</span><br><span class="line">        <span class="comment">//创建目录</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(basePath);</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            file.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(basePath + fileName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.success(basePath+fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件下载</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/download&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">(String name, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(basePath+name));</span><br><span class="line">                <span class="type">ServletOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        ) &#123;</span><br><span class="line">            response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len=fileInputStream.read(bytes))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                outputStream.write(bytes,<span class="number">0</span>,len);</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">YiMing</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://prehitting.gitee.io/2022/05/06/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/">https://prehitting.gitee.io/2022/05/06/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">YiMing</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/SpringBoot/"><span class="chip bg-color">SpringBoot</span> </a><a href="/tags/SpringMVC/"><span class="chip bg-color">SpringMVC</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/2022/05/06/SpringBoot%E5%A4%84%E7%90%86%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"><div class="card-image"><img src="/medias/featureimages/10.jpg" class="responsive-img" alt="SpringBoot处理跨域请求的几种方法"> <span class="card-title">SpringBoot处理跨域请求的几种方法</span></div></a><div class="card-content article-content"><div class="summary block-with-text"># Error： Access to XMLHttpRequest at &#x27;http://localhost:8080/store/users/reg&#x27; from origin &#x27;http://localhos</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-05-06 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SpringBoot/" class="post-category">SpringBoot</a></span></div></div><div class="card-action article-tags"><a href="/tags/SpringBoot/"><span class="chip bg-color">SpringBoot</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2022/05/06/Swagger%E9%85%8D%E7%BD%AE/"><div class="card-image"><img src="/medias/featureimages/3.jpg" class="responsive-img" alt="Swagger配置"> <span class="card-title">Swagger配置</span></div></a><div class="card-content article-content"><div class="summary block-with-text">一款致力于解决接口规范化，标准化，文档化的开源库 一款可以根据 restful 风格生成的接口开发文档，并且支持做测试的一款中间软件 使用 Swagger 你只需要按照它的规范去定义接口以及接口相关信息，再通过 Swagger 衍生出一</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-05-06 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Swagger/" class="post-category">Swagger</a></span></div></div><div class="card-action article-tags"><a href="/tags/Swagger/"><span class="chip bg-color">Swagger</span></a></div></div></div></div></article></div><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2022</span> <a href="/about" target="_blank">YiMing</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/prehitting" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:2480992876@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2480992876" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2480992876" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script></body></html>